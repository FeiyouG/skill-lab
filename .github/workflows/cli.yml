name: CLI

on:
    push:
        branches: [main]
        paths:
            - "packages/cli/**"
            - "packages/analyzer/**"
            - "packages/shared/**"
            - "scripts/**"
            - ".github/workflows/cli.yml"
    pull_request:
        branches: [main]
        paths:
            - "packages/cli/**"
            - "packages/analyzer/**"
            - "packages/shared/**"
            - "scripts/**"
            - ".github/workflows/cli.yml"
    release:
        types: [published]

jobs:
    test:
        name: Test & Lint (CLI + Shared)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Install Rust (stable) + wasm32 target
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown

            - name: Cache Rust build artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      /tmp/ast-grep-wasm-build/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Install wasm-pack
              run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

            - name: Build @ast-grep/wasm vendor artifact
              run: deno task setup

            - name: Shared checks
              run: deno task shared:check

            - name: Shared tests
              run: deno task shared:test

            - name: CLI checks
              run: deno task cli:check

            - name: CLI tests
              run: deno task cli:test

    build:
        name: Build Verify (Linux)
        runs-on: ubuntu-latest
        needs: test
        if: github.event_name == 'pull_request'
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Install Rust (stable) + wasm32 target
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown

            - name: Cache Rust build artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      /tmp/ast-grep-wasm-build/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Install wasm-pack
              run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

            - name: Build @ast-grep/wasm vendor artifact
              run: deno task setup

            - name: Build binary
              env:
                  SLAB_TARGET: x86_64-unknown-linux-gnu
                  SLAB_OUTPUT: slab-ci-linux-x64
              run: deno task cli:build

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: slab-ci-linux-x64
                  path: packages/cli/slab-ci-linux-x64

    build-nightly:
        name: Build Nightly Archives (${{ matrix.target }})
        runs-on: ${{ matrix.os }}
        needs: test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        strategy:
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      binary: slab
                      archive: slab-linux-x64.tar.gz
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      binary: slab
                      archive: slab-macos-arm64.tar.gz
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      binary: slab.exe
                      archive: slab-windows-x64.zip
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Install Rust (stable) + wasm32 target
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown

            - name: Cache Rust build artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      /tmp/ast-grep-wasm-build/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Install wasm-pack (Unix)
              if: runner.os != 'Windows'
              run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

            - name: Install wasm-pack (Windows)
              if: runner.os == 'Windows'
              run: cargo install wasm-pack

            - name: Build @ast-grep/wasm vendor artifact
              run: deno task setup

            - name: Build binary
              env:
                  SLAB_TARGET: ${{ matrix.target }}
                  SLAB_OUTPUT: ${{ matrix.binary }}
              run: deno task cli:build

            - name: Package archive (Unix)
              if: runner.os != 'Windows'
              run: tar -czf ${{ matrix.archive }} packages/cli/${{ matrix.binary }}

            - name: Package archive (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: Compress-Archive -Path packages/cli/${{ matrix.binary }} -DestinationPath ${{ matrix.archive }} -Force

            - name: Upload nightly archive artifact
              uses: actions/upload-artifact@v4
              with:
                  name: nightly-${{ matrix.archive }}
                  path: ${{ matrix.archive }}

    release-nightly:
        name: Upload Nightly Release Assets
        runs-on: ubuntu-latest
        needs: build-nightly
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: Download nightly artifacts
              uses: actions/download-artifact@v4
              with:
                  pattern: nightly-*
                  path: artifacts
                  merge-multiple: true

            - name: Generate nightly checksums
              run: |
                  rm -f artifacts/checksums-nightly.txt
                  for file in artifacts/*.tar.gz artifacts/*.zip; do
                    if [ -f "$file" ]; then
                      shasum -a 256 "$file" >> artifacts/checksums-nightly.txt
                    fi
                  done

            - name: Upload nightly release assets
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: nightly
                  name: Nightly Build
                  body: |
                      Nightly build from main branch

                      Commit: ${{ github.sha }}
                  files: artifacts/*
                  prerelease: true
                  draft: false

    build-release:
        name: Build Release (${{ matrix.target }})
        runs-on: ${{ matrix.os }}
        needs: test
        if: github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')
        strategy:
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      binary: slab
                      archive: slab-linux-x64.tar.gz
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      binary: slab
                      archive: slab-macos-arm64.tar.gz
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      binary: slab.exe
                      archive: slab-windows-x64.zip
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Install Rust (stable) + wasm32 target
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown

            - name: Cache Rust build artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      /tmp/ast-grep-wasm-build/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Install wasm-pack (Unix)
              if: runner.os != 'Windows'
              run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

            - name: Install wasm-pack (Windows)
              if: runner.os == 'Windows'
              run: cargo install wasm-pack

            - name: Build @ast-grep/wasm vendor artifact
              run: deno task setup

            - name: Build binary
              env:
                  SLAB_TARGET: ${{ matrix.target }}
                  SLAB_OUTPUT: ${{ matrix.binary }}
              run: deno task cli:build

            - name: Package archive (Unix)
              if: runner.os != 'Windows'
              run: tar -czf ${{ matrix.archive }} packages/cli/${{ matrix.binary }}

            - name: Package archive (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: Compress-Archive -Path packages/cli/${{ matrix.binary }} -DestinationPath ${{ matrix.archive }} -Force

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.archive }}
                  path: ${{ matrix.archive }}

    release:
        name: Upload Release Assets
        runs-on: ubuntu-latest
        needs: build-release
        if: github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Generate checksums
              run: |
                  shopt -s globstar
                  rm -f artifacts/checksums.txt
                  for file in artifacts/**/*.tar.gz artifacts/**/*.zip; do
                    if [ -f "$file" ]; then
                      shasum -a 256 "$file" >> artifacts/checksums.txt
                    fi
                  done

            - name: Upload release assets
              uses: softprops/action-gh-release@v1
              with:
                  files: artifacts/**/*
                  generate_release_notes: true

    publish-homebrew:
        name: Publish Homebrew Formula
        runs-on: ubuntu-latest
        needs: release
        if: github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')
        steps:
            - name: Download release archives
              env:
                  TAG: ${{ github.event.release.tag_name }}
                  OWNER: ${{ github.repository_owner }}
              run: |
                  curl -fsSL -o slab-macos-arm64.tar.gz "https://github.com/${OWNER}/skill-lab/releases/download/${TAG}/slab-macos-arm64.tar.gz"
                  curl -fsSL -o slab-linux-x64.tar.gz "https://github.com/${OWNER}/skill-lab/releases/download/${TAG}/slab-linux-x64.tar.gz"

            - name: Calculate checksums
              id: checksums
              run: |
                  echo "macos_arm64=$(shasum -a 256 slab-macos-arm64.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
                  echo "linux_x64=$(shasum -a 256 slab-linux-x64.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"

            - name: Clone tap repository
              env:
                  OWNER: ${{ github.repository_owner }}
                  TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
              run: git clone "https://x-access-token:${TOKEN}@github.com/${OWNER}/homebrew-tap.git" tap

            - name: Update formula
              env:
                  TAG: ${{ github.event.release.tag_name }}
                  VERSION: ${{ github.event.release.tag_name }}
                  OWNER: ${{ github.repository_owner }}
                  SHA_MACOS_ARM64: ${{ steps.checksums.outputs.macos_arm64 }}
                  SHA_LINUX_X64: ${{ steps.checksums.outputs.linux_x64 }}
              run: |
                  VERSION="${VERSION#v}"
                  mkdir -p tap/Formula
                  cat > tap/Formula/slab.rb <<EOF
                  class Slab < Formula
                    desc "Skill Lab CLI"
                    homepage "https://github.com/${OWNER}/skill-lab"
                    version "${VERSION}"
                    license "MIT"

                    on_macos do
                      if Hardware::CPU.intel?
                        odie "slab currently ships macOS binaries for Apple Silicon only"
                      end
                      url "https://github.com/${OWNER}/skill-lab/releases/download/${TAG}/slab-macos-arm64.tar.gz"
                      sha256 "${SHA_MACOS_ARM64}"
                    end

                    on_linux do
                      url "https://github.com/${OWNER}/skill-lab/releases/download/${TAG}/slab-linux-x64.tar.gz"
                      sha256 "${SHA_LINUX_X64}"
                    end

                    def install
                      bin.install "slab"
                    end
                  end
                  EOF

            - name: Commit and push formula
              working-directory: tap
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add Formula/slab.rb
                  if git diff --staged --quiet; then
                    echo "No formula changes"
                    exit 0
                  fi
                  git commit -m "chore: update slab formula for ${{ github.event.release.tag_name }}"
                  git push
