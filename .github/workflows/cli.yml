name: CLI

on:
    push:
        branches: [main]
        paths:
            - "packages/cli/**"
            - "packages/shared/**"
            - ".github/workflows/cli.yml"
    pull_request:
        branches: [main]
        paths:
            - "packages/cli/**"
            - "packages/shared/**"
            - ".github/workflows/cli.yml"
    release:
        types: [published]

jobs:
    test:
        name: Test & Lint (CLI + Shared)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Shared checks
              run: deno task shared:check

            - name: Shared tests
              run: deno task shared:test

            - name: CLI checks
              run: deno task cli:check

            - name: CLI tests
              run: deno task cli:test

    build:
        name: Build Verify (Linux)
        runs-on: ubuntu-latest
        needs: test
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Build binary
              run: deno compile --allow-net --allow-read --allow-write --allow-env --allow-ffi --target x86_64-unknown-linux-gnu --output slab-ci-linux-x64 packages/cli/src/main.ts

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: slab-ci-linux-x64
                  path: slab-ci-linux-x64

    build-nightly:
        name: Build Nightly (Linux)
        runs-on: ubuntu-latest
        needs: test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Build binary
              run: deno compile --allow-net --allow-read --allow-write --allow-env --allow-ffi --target x86_64-unknown-linux-gnu --output slab-nightly-linux-x64 packages/cli/src/main.ts

            - name: Create/Update nightly release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: nightly
                  name: Nightly Build
                  body: |
                      Nightly build from main branch

                      Commit: ${{ github.sha }}
                      Date: ${{ github.event.head_commit.timestamp }}
                  files: slab-nightly-linux-x64
                  prerelease: true
                  draft: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build-release:
        name: Build Release (${{ matrix.target }})
        runs-on: ${{ matrix.os }}
        needs: test
        if: github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')
        strategy:
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                      artifact: slab-linux-x64
                    - target: x86_64-apple-darwin
                      os: macos-latest
                      artifact: slab-macos-x64
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      artifact: slab-macos-arm64
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      artifact: slab-windows-x64.exe
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Build binary
              run: deno compile --allow-net --allow-read --allow-write --allow-env --allow-ffi --target ${{ matrix.target }} --output ${{ matrix.artifact }} packages/cli/src/main.ts

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}

    release:
        name: Upload Release Assets
        runs-on: ubuntu-latest
        needs: build-release
        if: github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Upload release assets
              uses: softprops/action-gh-release@v1
              with:
                  files: artifacts/**/*
                  generate_release_notes: true
