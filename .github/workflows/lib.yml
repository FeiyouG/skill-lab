name: Skill Lab Library

on:
    push:
        branches: [main]
        paths:
            - "scripts/**"
            - "deno.json"
            - "packages/skillreader/**"
            - "packages/analyzer/**"
            - "packages/shared/**"
            - ".github/workflows/lib.yml"
    pull_request:
        branches: [main]
        paths:
            - "scripts/**"
            - "deno.json"
            - "packages/skillreader/**"
            - "packages/analyzer/**"
            - "packages/shared/**"
            - ".github/workflows/lib.yml"
    release:
        types: [published]

jobs:
    test:
        name: Test & Lint (Lib + Shared)
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Install Rust (stable) + wasm32 target
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown

            - name: Cache Rust build artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      /tmp/ast-grep-wasm-build/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Install wasm-pack
              run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

            - name: Build @ast-grep/wasm vendor artifact
              run: deno task setup

            - name: Shared checks
              run: deno task shared:check

            - name: Shared tests
              run: deno task shared:test

            - name: SkillReader checks
              run: deno task skillreader:check

            - name: SkillReader tests
              run: deno task skillreader:test

            - name: Analyzer checks
              run: deno task analyzer:check

            - name: Analyzer tests
              run: deno task analyzer:test

    npm-build:
        name: Build npm package
        runs-on: ubuntu-latest
        needs: test
        if: |
            github.event_name == 'push' ||
            github.event_name == 'pull_request' ||
            (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v'))
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Install Rust (stable) + wasm32 target
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown

            - name: Cache Rust build artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      /tmp/ast-grep-wasm-build/target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

            - name: Install wasm-pack
              run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

            - name: Build @ast-grep/wasm vendor artifact
              run: deno task setup

            - name: Build npm output
              run: deno task npm:build

            - name: Pack npm tarball
              run: npm pack ./npm

            - name: Upload npm artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: skill-lab-npm
                  path: |
                      npm
                      *.tgz

    npm-publish:
        name: Publish npm package
        runs-on: ubuntu-latest
        needs: npm-build
        if: github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v')
        permissions:
            contents: read
            id-token: write
        environment: production
        steps:
            - uses: actions/checkout@v4

            - uses: denoland/setup-deno@v2
              with:
                  deno-version: v2.x

            - uses: actions/setup-node@v4
              with:
                  node-version: 24
                  registry-url: https://registry.npmjs.org

            - name: Show Node and npm versions
              run: |
                  node -v
                  npm -v

            - name: Cache Deno dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/deno
                      ~/.deno
                  key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}

            - name: Build npm output for release tag
              run: deno task npm:build ${{ github.event.release.tag_name }}

            - name: Publish to npm
              run: npm publish ./npm --access public --provenance
